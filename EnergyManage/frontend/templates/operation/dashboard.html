<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>运维仪表板 - 智慧能源管理系统</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
        }
        body {
            background-color: #f8f9fa;
        }
        .sidebar {
            background: linear-gradient(180deg, var(--primary) 0%, var(--secondary) 100%);
            min-height: 100vh;
            color: white;
            position: fixed;
            width: 250px;
            transition: all 0.3s;
        }
        .sidebar-header {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .nav-link {
            color: rgba(255,255,255,0.8);
            padding: 12px 20px;
            margin: 5px 10px;
            border-radius: 10px;
            transition: all 0.3s;
        }
        .nav-link:hover, .nav-link.active {
            color: white;
            background: rgba(255,255,255,0.1);
        }
        .nav-link i {
            width: 24px;
            text-align: center;
            margin-right: 10px;
        }
        .main-content {
            margin-left: 250px;
            padding: 20px;
            transition: all 0.3s;
        }
        .navbar {
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 15px 0;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            transition: all 0.3s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 15px;
        }
        .stat-number {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        .stat-title {
            color: #6c757d;
            font-size: 14px;
        }
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        .welcome-text {
            font-size: 18px;
            color: #333;
        }
        .welcome-text span {
            color: var(--primary);
            font-weight: 600;
        }
        .recent-activity {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        .activity-item {
            padding: 15px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
        }
        .activity-item:last-child {
            border-bottom: none;
        }
        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(102, 126, 234, 0.1);
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
        }
        .activity-content {
            flex: 1;
        }
        .activity-title {
            font-weight: 600;
            margin-bottom: 5px;
        }
        .activity-time {
            color: #6c757d;
            font-size: 12px;
        }
        .equipment-health {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        .health-progress {
            height: 10px;
            border-radius: 5px;
            background: #e9ecef;
            overflow: hidden;
        }
        .health-progress-bar {
            height: 100%;
            transition: width 0.6s ease;
        }
        @media (max-width: 768px) {
            .sidebar {
                margin-left: -250px;
            }
            .main-content {
                margin-left: 0;
            }
            .sidebar.active {
                margin-left: 0;
            }
        }
        .reminder-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 5px solid #dc3545;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
            transition: all 0.3s;
        }
        .reminder-card:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .reminder-card.high { border-left-color: #dc3545; }
        .reminder-card.medium { border-left-color: #ffc107; }
        .reminder-card.low { border-left-color: #17a2b8; }
        .reminder-time {
            font-size: 12px;
            color: #6c757d;
        }
        .reminder-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }
        .badge-high { background: #f8d7da; color: #721c24; }
        .badge-medium { background: #fff3cd; color: #856404; }
        .badge-low { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <!-- 侧边栏 -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <i class="fas fa-bolt fa-2x mb-2"></i>
            <h5>能源管理系统</h5>
            <small>运维版</small>
        </div>
        <nav class="nav flex-column mt-3">
            <a class="nav-link active" href="/operation/dashboard">
                <i class="fas fa-tachometer-alt"></i> 仪表板
            </a>
            <a class="nav-link" href="/operation/work_orders">
                <i class="fas fa-clipboard-list"></i> 工单管理
                <span class="badge bg-danger float-end" id="pendingBadge">0</span>
            </a>
            <a class="nav-link" href="/operation/equipment">
                <i class="fas fa-cogs"></i> 设备管理
            </a>
            <a class="nav-link" href="/operation/alerts">
                <i class="fas fa-exclamation-triangle"></i> 告警管理
                <span class="badge bg-danger float-end" id="alertBadge">0</span>
            </a>
            <a class="nav-link" href="/operation/profile">
                <i class="fas fa-user-circle"></i> 个人中心
            </a>

            <div class="mt-auto">
                <a class="nav-link text-danger" href="#" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> 退出登录
                </a>
            </div>
        </nav>
    </div>

    <!-- 主内容区 -->
    <div class="main-content" id="mainContent">
        <!-- 顶部导航 -->
        <nav class="navbar">
            <div class="container-fluid">
                <button class="btn d-md-none" id="sidebarToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="welcome-text">
                    欢迎回来，<span id="userName">运维人员</span>
                </div>
                <div class="d-flex align-items-center">
                    <div class="me-3">
                        <small class="text-muted">当前时间：</small>
                        <span id="currentTime"></span>
                    </div>
                    <div class="dropdown">
                        <button class="btn btn-outline-primary dropdown-toggle" type="button"
                                data-bs-toggle="dropdown">
                            <i class="fas fa-user me-2"></i>
                            <span id="userRole">运维人员</span>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="profile.html">
                                <i class="fas fa-user me-2"></i>个人资料
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger" href="#" id="logoutBtn2">
                                <i class="fas fa-sign-out-alt me-2"></i>退出登录
                            </a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </nav>

        <!-- 统计卡片 -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-icon bg-primary bg-opacity-10 text-primary">
                        <i class="fas fa-clipboard-list"></i>
                    </div>
                    <div class="stat-number" id="totalOrders">0</div>
                    <div class="stat-title">总工单数</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-icon bg-warning bg-opacity-10 text-warning">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-number" id="pendingOrders">0</div>
                    <div class="stat-title">待处理工单</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-icon bg-success bg-opacity-10 text-success">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-number" id="completedOrders">0</div>
                    <div class="stat-title">已完成工单</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-icon bg-danger bg-opacity-10 text-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="stat-number" id="highAlarms">0</div>
                    <div class="stat-title">高等级告警</div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- 设备状态统计 -->
            <div class="col-md-8">
                <div class="stat-card">
                    <h5 class="mb-3">
                        <i class="fas fa-cogs me-2"></i>设备状态统计
                    </h5>
                    <div id="equipmentStats" class="row">
                        <!-- 设备统计会通过JavaScript动态加载 -->
                        <div class="col-3 text-center">
                            <div class="stat-icon bg-success bg-opacity-10 text-success mx-auto mb-2">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div class="stat-number" id="normalEquipment">0</div>
                            <div class="stat-title">正常运行</div>
                        </div>
                        <div class="col-3 text-center">
                            <div class="stat-icon bg-warning bg-opacity-10 text-warning mx-auto mb-2">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="stat-number" id="faultEquipment">0</div>
                            <div class="stat-title">故障设备</div>
                        </div>
                        <div class="col-3 text-center">
                            <div class="stat-icon bg-danger bg-opacity-10 text-danger mx-auto mb-2">
                                <i class="fas fa-times-circle"></i>
                            </div>
                            <div class="stat-number" id="maintenanceEquipment">0</div>
                            <div class="stat-title">维护中</div>
                        </div>
                        <div class="col-3 text-center">
                            <div class="stat-icon bg-info bg-opacity-10 text-info mx-auto mb-2">
                                <i class="fas fa-plug"></i>
                            </div>
                            <div class="stat-number" id="offlineEquipment">0</div>
                            <div class="stat-title">离线</div>
                        </div>
                    </div>

                    <!-- 设备健康度 -->
                    <div class="equipment-health">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="fw-bold">设备健康度</span>
                            <span id="healthPercentage" class="fw-bold">0%</span>
                        </div>
                        <div class="health-progress">
                            <div id="healthProgress" class="health-progress-bar bg-success" style="width: 0%"></div>
                        </div>
                        <div class="mt-2 text-muted small">
                            <i class="fas fa-info-circle me-1"></i>
                            基于正常运行设备比例计算
                        </div>
                    </div>
                </div>
            </div>
            <!-- 工单提醒模块 -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="stat-card">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5>
                                <i class="fas fa-bell me-2"></i>工单处理提醒
                                <span class="badge bg-danger ms-2" id="reminderBadge">0</span>
                            </h5>
                            <button class="btn btn-sm btn-outline-primary" onclick="loadReminders()">
                                <i class="fas fa-sync-alt"></i> 刷新
                            </button>
                        </div>

                        <div id="remindersList">
                            <div class="text-center py-4">
                                <i class="fas fa-spinner fa-spin"></i> 加载提醒中...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 最近活动 -->
            <div class="col-md-4">
                <div class="recent-activity">
                    <h5 class="mb-3">最近活动</h5>
                    <div id="recentActivities">
                        <!-- 活动内容动态加载 -->
                        <div class="text-center py-4">
                            <i class="fas fa-spinner fa-spin"></i> 加载中...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 待处理工单 -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="stat-card">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5>待处理工单</h5>
                        <a href="/operation/work_orders" class="btn btn-sm btn-outline-primary">
                            查看全部 <i class="fas fa-arrow-right"></i>
                        </a>
                    </div>
                    <div id="pendingWorkOrders">
                        <!-- 工单列表动态加载 -->
                        <div class="text-center py-4">
                            <i class="fas fa-spinner fa-spin"></i> 加载中...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // API基础URL
        const API_BASE = '/api';

        // 检查登录状态
        checkLogin();

        // 侧边栏切换（移动端）
        document.getElementById('sidebarToggle').addEventListener('click', function() {
            document.getElementById('sidebar').classList.toggle('active');
        });

        // 更新时间
        function updateTime() {
            const now = new Date();
            const timeStr = now.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
            document.getElementById('currentTime').textContent = timeStr;
        }
        updateTime();
        setInterval(updateTime, 1000);

        // 加载仪表板数据
        loadDashboardData();

        // 退出登录
        document.getElementById('logoutBtn').addEventListener('click', logout);
        document.getElementById('logoutBtn2').addEventListener('click', logout);

        // 函数定义
    // 添加 verifyLogin 函数定义（放在 checkLogin 函数之前）
async function verifyLogin() {
    try {
        const response = await fetch('/api/check-login', {
            method: 'GET',
            credentials: 'include'
        });

        if (!response.ok) {
            console.log('登录验证失败，重定向到登录页');
            window.location.href = '/login';
            return null;
        }

        const result = await response.json();

        if (result.success) {
            console.log('用户已登录:', result.data.real_name);
            return result.data;
        } else {
            console.log('登录验证失败，重定向到登录页');
            window.location.href = '/login';
            return null;
        }
    } catch (error) {
        console.error('验证登录状态失败:', error);
        window.location.href = '/login';
        return null;
    }
}
        async function checkLogin() {
    try {
        const response = await fetch('/api/check-login', {
            method: 'GET',
            credentials: 'include'
        });

        if (response.status === 401) {
            console.log('未登录，跳转到登录页');
            window.location.href = '/login';
            return;
        }

        const result = await response.json();
        console.log('登录检查结果:', result);

        if (result.success) {
            const user = result.data;
            console.log('用户信息:', user);

            // 更新页面上的用户信息
            if (document.getElementById('userName')) {
                document.getElementById('userName').textContent = user.real_name || '运维人员';
            }
            if (document.getElementById('userRole')) {
                document.getElementById('userRole').textContent = user.role || '运维人员';
            }

            // 加载数据
            loadDashboardData();
        } else {
            console.log('登录检查失败，跳转到登录页');
            window.location.href = '/login';
        }
    } catch (error) {
        console.error('检查登录状态失败:', error);
        window.location.href = '/login';
    }
}


        // async function loadDashboardData() {
        //     try {
        //         const response = await fetch(`${API_BASE}/dashboard/stats`, {
        //     method: 'GET',
        //     credentials: 'include'  // 重要：包含cookies/session
        // });
        //
        // if (response.status === 401) {
        //     // 未授权，跳转到登录页
        //     window.location.href = '/login';
        //     return;
        // }
        //         const token = localStorage.getItem('token');
        //         const user = JSON.parse(localStorage.getItem('user') || '{}');
        //
        //         // 并行加载多个数据
        //         const [statsResponse, equipmentResponse, ordersResponse] = await Promise.all([
        //             fetch(`${API_BASE}/dashboard/stats`, { headers: { 'Authorization': token } }),
        //             fetch(`${API_BASE}/equipment`, { headers: { 'Authorization': token } }),
        //             fetch(`${API_BASE}/work-orders?status=pending`, { headers: { 'Authorization': token } })
        //         ]);
        //
        //         // 处理统计数据
        //         if (statsResponse.ok) {
        //             const statsResult = await statsResponse.json();
        //             if (statsResult.success) {
        //                 const stats = statsResult.data;
        //                 updateStatsCards(stats);
        //             }
        //         }
        //
        //         // 处理设备数据
        //         if (equipmentResponse.ok) {
        //             const equipmentResult = await equipmentResponse.json();
        //             if (equipmentResult.success) {
        //                 updateEquipmentStats(equipmentResult.data);
        //             }
        //         }
        //
        //         // 处理待处理工单
        //         if (ordersResponse.ok) {
        //             const ordersResult = await ordersResponse.json();
        //             updatePendingOrders(ordersResult.data || []);
        //         }
        //
        //         // 加载提醒
        //         await loadReminders();
        //         await updateAlertBadge();
        //
        //     } catch (error) {
        //         console.error('加载仪表板数据失败:', error);
        //         showToast('部分数据加载失败，请检查网络连接', 'warning');
        //     }
        // }
        async function loadDashboardData() {
    try {
        console.log('开始加载仪表板数据...');

        // 使用运维专用的API
        const response = await fetch('/api/operation/dashboard-data', {
            method: 'GET',
            credentials: 'include'
        });

        console.log('仪表板数据响应状态:', response.status);

        if (response.status === 401) {
            console.log('未授权，跳转到登录页');
            window.location.href = '/login';
            return;
        }

        const result = await response.json();
        console.log('仪表板数据:', result);

        if (result.success) {
            updateStatsCards(result.data.stats);
            updateEquipmentStats(result.data.equipment);
            updateRecentActivities(result.data.recent_activities);
            updatePendingOrders(result.data.pending_orders);
        } else {
            console.error('API返回失败:', result.message);
            showToast('数据加载失败: ' + result.message, 'danger');
        }

        // 加载其他数据
        await loadReminders();
        await updateAlertBadge();

        console.log('仪表板数据加载完成');

    } catch (error) {
        console.error('加载仪表板数据失败:', error);
        showToast('网络错误，请检查连接', 'warning');
    }
}

        // function updateStatsCards(stats) {
        //     // 更新卡片显示
        //     if (stats) {
        //         document.getElementById('totalOrders').textContent = stats.total || 0;
        //         document.getElementById('pendingOrders').textContent = stats.pending || 0;
        //         document.getElementById('completedOrders').textContent = stats.completed || 0;
        //         document.getElementById('highAlarms').textContent = stats.high_alarms || 0;
        //
        //         // 更新侧边栏徽章
        //         document.getElementById('pendingBadge').textContent = stats.pending || 0;
        //     }
        // }
        //
        // function updateEquipmentStats(equipment) {
        //     if (!equipment || equipment.length === 0) return;
        //
        //     // 统计设备状态
        //     const stats = {
        //         normal: 0,
        //         fault: 0,
        //         maintenance: 0,
        //         offline: 0,
        //         total: equipment.length
        //     };
        //
        //     equipment.forEach(eq => {
        //         const status = eq.运行状态 || '正常';
        //         if (status === '正常') stats.normal++;
        //         else if (status === '故障') stats.fault++;
        //         else if (status === '维护中') stats.maintenance++;
        //         else if (status === '离线') stats.offline++;
        //     });
        //
        //     // 更新显示
        //     document.getElementById('normalEquipment').textContent = stats.normal;
        //     document.getElementById('faultEquipment').textContent = stats.fault;
        //     document.getElementById('maintenanceEquipment').textContent = stats.maintenance;
        //     document.getElementById('offlineEquipment').textContent = stats.offline;
        //
        //     // 计算并显示健康度
        //     const healthPercentage = stats.total > 0 ?
        //         Math.round((stats.normal / stats.total) * 100) : 0;
        //     document.getElementById('healthPercentage').textContent = `${healthPercentage}%`;
        //
        //     const progressBar = document.getElementById('healthProgress');
        //     progressBar.style.width = `${healthPercentage}%`;
        //
        //     // 根据健康度设置颜色
        //     if (healthPercentage >= 80) {
        //         progressBar.className = 'health-progress-bar bg-success';
        //     } else if (healthPercentage >= 60) {
        //         progressBar.className = 'health-progress-bar bg-warning';
        //     } else {
        //         progressBar.className = 'health-progress-bar bg-danger';
        //     }
        //
        //     console.log(`设备健康度: ${healthPercentage}% (正常: ${stats.normal}/${stats.total})`);
        // }
        function updateStatsCards(stats) {
    // 更新卡片显示
    if (stats) {
        document.getElementById('totalOrders').textContent = stats.total_orders || 0;
        document.getElementById('pendingOrders').textContent = stats.pending_orders || 0;
        document.getElementById('completedOrders').textContent = stats.completed_orders || 0;
        document.getElementById('highAlarms').textContent = stats.high_alarms || 0;

        // 更新侧边栏徽章
        document.getElementById('pendingBadge').textContent = stats.pending_orders || 0;
    }
}

// 修改 updateEquipmentStats 函数
function updateEquipmentStats(equipment) {
    if (!equipment) return;

    // 更新显示
    document.getElementById('normalEquipment').textContent = equipment.normal || 0;
    document.getElementById('faultEquipment').textContent = equipment.fault || 0;
    document.getElementById('maintenanceEquipment').textContent = equipment.maintenance || 0;
    document.getElementById('offlineEquipment').textContent = equipment.offline || 0;

    // 计算并显示健康度
    const total = equipment.total || 0;
    const normal = equipment.normal || 0;
    const healthPercentage = total > 0 ? Math.round((normal / total) * 100) : 0;

    document.getElementById('healthPercentage').textContent = `${healthPercentage}%`;

    const progressBar = document.getElementById('healthProgress');
    progressBar.style.width = `${healthPercentage}%`;

    // 根据健康度设置颜色
    if (healthPercentage >= 80) {
        progressBar.className = 'health-progress-bar bg-success';
    } else if (healthPercentage >= 60) {
        progressBar.className = 'health-progress-bar bg-warning';
    } else {
        progressBar.className = 'health-progress-bar bg-danger';
    }

    console.log(`设备健康度: ${healthPercentage}% (正常: ${normal}/${total})`);
}

        function updateRecentActivities(activities) {
            const container = document.getElementById('recentActivities');

            if (!activities || activities.length === 0) {
                container.innerHTML = '<div class="text-center py-4 text-muted">暂无活动记录</div>';
                return;
            }

            let html = '';
            activities.forEach(activity => {
                if (!activity.处理完成时间) return;

                const time = new Date(activity.处理完成时间).toLocaleString('zh-CN', {
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                html += `
                <div class="activity-item">
                    <div class="activity-icon">
                        <i class="fas fa-clipboard-check"></i>
                    </div>
                    <div class="activity-content">
                        <div class="activity-title">完成工单 ${activity.工单编号}</div>
                        <div class="activity-desc text-muted">${activity.处理结果 ? activity.处理结果.substring(0, 30) + '...' : '无描述'}</div>
                        <div class="activity-time">${time}</div>
                    </div>
                </div>
                `;
            });

            if (html === '') {
                html = '<div class="text-center py-4 text-muted">暂无已完成工单</div>';
            }

            container.innerHTML = html;
        }

        function updatePendingOrders(orders) {
            const container = document.getElementById('pendingWorkOrders');

            if (!orders || orders.length === 0) {
                container.innerHTML = '<div class="text-center py-4 text-muted">暂无待处理工单</div>';
                return;
            }

            let html = '<div class="table-responsive"><table class="table table-hover">';
            html += `
            <thead>
                <tr>
                    <th>工单编号</th>
                    <th>告警内容</th>
                    <th>设备</th>
                    <th>告警等级</th>
                    <th>派单时间</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
            `;

            orders.slice(0, 5).forEach(order => {  // 只显示前5个
                const levelColor = order.告警等级 === '高' ? 'danger' :
                                order.告警等级 === '中' ? 'warning' : 'secondary';

                const time = new Date(order.派单时间).toLocaleString('zh-CN', {
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                html += `
                <tr>
                    <td>${order.工单编号 || '未知'}</td>
                    <td>${order.告警内容 ? order.告警内容.substring(0, 30) + '...' : '无描述'}</td>
                    <td>${order.设备名称 || '未知设备'}</td>
                    <td><span class="badge bg-${levelColor}">${order.告警等级 || '中'}</span></td>
                    <td>${time}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary"
                                onclick="window.location.href='/operation/work_orders?order=${order.工单ID}'">
                            <i class="fas fa-external-link-alt"></i> 处理
                        </button>
                    </td>
                </tr>
                `;
            });

            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        async function respondToOrder(orderId) {
            if (!confirm('确认响应该工单？')) return;

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/work-orders/${orderId}/respond`, {
                    method: 'POST',
                    headers: {
                        'Authorization': token,
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (result.success) {
                    showToast('响应成功', 'success');
                    // 刷新数据
                    loadDashboardData();
                } else {
                    showToast(result.message || '响应失败', 'danger');
                }
            } catch (error) {
                console.error('响应工单失败:', error);
                showToast('网络错误，请重试', 'danger');
            }
        }

        async function loadReminders() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/reminders`, {
                    headers: { 'Authorization': token }
                });

                if (response.status === 401) {
                    localStorage.clear();
                    window.location.href = 'index.html';
                    return;
                }

                const result = await response.json();
                const container = document.getElementById('remindersList');

                if (!result.success || !result.data || result.data.length === 0) {
                    container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-check-circle fa-2x text-success mb-3"></i>
                        <h6 class="text-success">暂无待处理提醒</h6>
                        <p class="text-muted small">所有工单都在处理期限内</p>
                    </div>
                    `;
                    document.getElementById('reminderBadge').textContent = '0';
                    return;
                }

                // 更新徽章
                document.getElementById('reminderBadge').textContent = result.data.length;

                let html = '';
                result.data.forEach(reminder => {
                    html += createReminderCard(reminder);
                });

                container.innerHTML = html;

            } catch (error) {
                console.error('加载提醒失败:', error);
                const container = document.getElementById('remindersList');
                container.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    加载提醒失败
                    <button class="btn btn-sm btn-outline-danger float-end" onclick="loadReminders()">
                        重试
                    </button>
                </div>
                `;
            }
        }

        function createReminderCard(reminder) {
    // 安全地检查提醒类型
    const reminderType = reminder.提醒类型 || '';

    let priorityClass = 'low';
    let badgeClass = 'badge-low';

    if (reminderType.includes('高')) {
        priorityClass = 'high';
        badgeClass = 'badge-high';
    } else if (reminderType.includes('中')) {
        priorityClass = 'medium';
        badgeClass = 'badge-medium';
    }

    // 格式化时间
    let remindTime = '未知时间';
    let assignTime = '未知时间';

    try {
        if (reminder.提醒时间) {
            remindTime = new Date(reminder.提醒时间).toLocaleString('zh-CN');
        }
        if (reminder.派单时间) {
            assignTime = new Date(reminder.派单时间).toLocaleString('zh-CN');
        }
    } catch (error) {
        console.error('时间格式化错误:', error);
    }

    // 计算剩余时间
    let timeLeft = '';
    try {
        if (reminder.提醒时间) {
            const now = new Date();
            const remindDate = new Date(reminder.提醒时间);
            const timeDiff = remindDate - now;

            if (timeDiff > 0) {
                const hours = Math.floor(timeDiff / (1000 * 60 * 60));
                const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));

                if (hours > 0) {
                    timeLeft = `${hours}小时${minutes}分钟后到期`;
                } else {
                    timeLeft = `${minutes}分钟后到期`;
                }
            } else {
                timeLeft = '已过期';
            }
        }
    } catch (error) {
        console.error('计算剩余时间错误:', error);
        timeLeft = '时间计算错误';
    }

    return  `
             <div class="reminder-card ${priorityClass}">
        <div class="d-flex justify-content-between align-items-start">
            <div class="flex-grow-1">
                <div class="d-flex align-items-center mb-2">
                    <h6 class="mb-0 me-2">${reminder.工单编号 || '未知工单'}</h6>
                    <span class="reminder-badge ${badgeClass}">${reminderType || '提醒'}</span>
                </div>
                <p class="mb-2">${reminder.提醒内容 || '无提醒内容'}</p>
                <div class="reminder-time">
                    <i class="far fa-clock me-1"></i>派单时间: ${assignTime}
                </div>
                <div class="reminder-time">
                    <i class="fas fa-hourglass-end me-1"></i>${timeLeft}
                </div>
            </div>
            <div>
                <button class="btn btn-sm btn-outline-primary"
                        onclick="goToWorkOrder('${reminder.工单ID || ''}')">
                    <i class="fas fa-external-link-alt"></i> 处理
                </button>
            </div>
        </div>
    </div>
            `;
        }

        function goToWorkOrder(workOrderId) {
            window.location.href = `work_orders.html?order=${workOrderId}`;
        }

        async function logout() {
            try {
                const token = localStorage.getItem('token');
                await fetch(`${API_BASE}/logout`, {
                    method: 'POST',
                    headers: { 'Authorization': token }
                });
            } catch (error) {
                console.error('退出登录失败:', error);
            } finally {
                localStorage.clear();
                window.location.href = '/login';
            }
        }

        function showToast(message, type = 'info') {
            // 创建toast元素
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type} border-0`;
            toast.setAttribute('role', 'alert');
            toast.setAttribute('aria-live', 'assertive');
            toast.setAttribute('aria-atomic', 'true');

            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fas fa-${type === 'success' ? 'check' : 'exclamation'}-circle me-2"></i>
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto"
                            data-bs-dismiss="toast"></button>
                </div>
            `;

            // 添加到页面
            document.body.appendChild(toast);

            // 显示toast
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();

            // 自动移除
            toast.addEventListener('hidden.bs.toast', () => {
                document.body.removeChild(toast);
            });
        }

        // 刷新按钮（如果需要可以添加）
        function refreshDashboard() {
            loadDashboardData();
            showToast('正在刷新数据...', 'info');
        }

        // 添加键盘快捷键（可选）
        document.addEventListener('DOMContentLoaded', async function() {
    const userInfo = await verifyLogin();
    if (userInfo) {
        // 用户已登录，加载数据
        loadDashboardData();
    }
});

        // 通用函数 - 更新告警徽章
        async function updateAlertBadge() {
            try {
                const token = localStorage.getItem('token');

                // 获取未处理的告警数量
                const response = await fetch(`${API_BASE}/alert-badge`, {
                    headers: { 'Authorization': token }
                });

                if (response.ok) {
                    const result = await response.json();
                    const count = result.count || 0;

                    // 更新所有页面中的告警徽章
                    const badges = document.querySelectorAll('#alertBadge, .alert-badge');
                    badges.forEach(badge => {
                        badge.textContent = count;
                        badge.style.display = count > 0 ? 'inline' : 'none';
                    });

                    return count;
                }
                return 0;
            } catch (error) {
                console.error('更新告警徽章失败:', error);
                return 0;
            }
        }

        // 页面加载时更新告警徽章
        document.addEventListener('DOMContentLoaded', function() {
            checkLogin();
            // 立即更新一次
            updateAlertBadge();

            // 设置定期更新（每30秒）
            setInterval(updateAlertBadge, 30000);

            // 页面获得焦点时更新
            document.addEventListener('visibilitychange', function() {
                if (!document.hidden) {
                    updateAlertBadge();
                }
            });
        });
    </script>
</body>
</html>