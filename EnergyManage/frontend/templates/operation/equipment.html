<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¾å¤‡ç®¡ç† - æ™ºæ…§èƒ½æºç®¡ç†ç³»ç»Ÿ</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- DataTables -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
    <style>
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
        }
        body {
            background-color: #f8f9fa;
        }
        .sidebar {
            background: linear-gradient(180deg, var(--primary) 0%, var(--secondary) 100%);
            min-height: 100vh;
            color: white;
            position: fixed;
            width: 250px;
        }
        .sidebar-header {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .nav-link {
            color: rgba(255,255,255,0.8);
            padding: 12px 20px;
            margin: 5px 10px;
            border-radius: 10px;
            transition: all 0.3s;
        }
        .nav-link:hover, .nav-link.active {
            color: white;
            background: rgba(255,255,255,0.1);
        }
        .nav-link i {
            width: 24px;
            text-align: center;
            margin-right: 10px;
        }
        .main-content {
            margin-left: 250px;
            padding: 20px;
        }
        .page-header {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        .equipment-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            transition: all 0.3s;
        }
        .equipment-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .equipment-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            margin-bottom: 15px;
        }
        .icon-electric { background: rgba(102, 126, 234, 0.1); color: var(--primary); }
        .icon-solar { background: rgba(255, 193, 7, 0.1); color: #ffc107; }
        .icon-water { background: rgba(13, 202, 240, 0.1); color: #0dcaf0; }
        .icon-gas { background: rgba(25, 135, 84, 0.1); color: #198754; }
        .equipment-status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .status-normal { background: #d4edda; color: #155724; }
        .status-fault { background: #f8d7da; color: #721c24; }
        .status-maintenance { background: #fff3cd; color: #856404; }
        .status-offline { background: #d1ecf1; color: #0c5460; }
        .filter-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .search-box {
            position: relative;
        }
        .search-box input {
            padding-left: 45px;
            border-radius: 10px;
        }
        .search-box i {
            position: absolute;
            left: 15px;
            top: 12px;
            color: #6c757d;
        }
        .category-filter {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .category-btn {
            padding: 8px 20px;
            border-radius: 20px;
            border: 2px solid #e0e0e0;
            background: white;
            color: #666;
            transition: all 0.3s;
            cursor: pointer;
        }
        .category-btn.active {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }
        .category-btn:hover:not(.active) {
            border-color: var(--primary);
            color: var(--primary);
        }
        @media (max-width: 768px) {
            .sidebar {
                margin-left: -250px;
            }
            .main-content {
                margin-left: 0;
            }
            .sidebar.active {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <!-- ä¾§è¾¹æ  -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <i class="fas fa-bolt fa-2x mb-2"></i>
            <h5>èƒ½æºç®¡ç†ç³»ç»Ÿ</h5>
            <small>è¿ç»´ç‰ˆ</small>
        </div>
        <nav class="nav flex-column mt-3">
            <a class="nav-link active" href="/operation/dashboard">
                <i class="fas fa-tachometer-alt"></i> ä»ªè¡¨æ¿
            </a>
            <a class="nav-link" href="/operation/work_orders">
                <i class="fas fa-clipboard-list"></i> å·¥å•ç®¡ç†
                <span class="badge bg-danger float-end" id="pendingBadge">0</span>
            </a>
            <a class="nav-link" href="/operation/equipment">
                <i class="fas fa-cogs"></i> è®¾å¤‡ç®¡ç†
            </a>
            <a class="nav-link" href="/operation/alerts">
                <i class="fas fa-exclamation-triangle"></i> å‘Šè­¦ç®¡ç†
                <span class="badge bg-danger float-end" id="alertBadge">0</span>
            </a>
            <a class="nav-link" href="/operation/profile">
                <i class="fas fa-user-circle"></i> ä¸ªäººä¸­å¿ƒ
            </a>
            <div class="mt-auto">
                <a class="nav-link text-danger" href="#" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> é€€å‡ºç™»å½•
                </a>
            </div>
        </nav>
    </div>

    <!-- ä¸»å†…å®¹åŒº -->
    <div class="main-content" id="mainContent">
        <!-- é¡µé¢æ ‡é¢˜ -->
        <div class="page-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2><i class="fas fa-cogs me-2"></i>è®¾å¤‡ç®¡ç†</h2>
                    <p class="text-muted mb-0">æŸ¥çœ‹å’Œç®¡ç†æ‰€è´Ÿè´£çš„è®¾å¤‡</p>
                </div>
                <div>
                    <button class="btn btn-primary" onclick="refreshEquipment()">
                        <i class="fas fa-sync-alt"></i> åˆ·æ–°
                    </button>
                </div>
            </div>
        </div>

        <!-- ç­›é€‰åŒºåŸŸ -->
        <div class="filter-section">
            <div class="row">
                <div class="col-md-6">
                    <div class="search-box mb-3">
                        <i class="fas fa-search"></i>
                        <input type="text" class="form-control" id="searchInput"
                               placeholder="æœç´¢è®¾å¤‡åç§°æˆ–ç¼–å·..." onkeyup="filterEquipment()">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">è®¾å¤‡çŠ¶æ€ç­›é€‰</label>
                        <select class="form-select" id="statusFilter" onchange="filterEquipment()">
                            <option value="all">å…¨éƒ¨çŠ¶æ€</option>
                            <option value="æ­£å¸¸">æ­£å¸¸</option>
                            <option value="æ•…éšœ">æ•…éšœ</option>
                            <option value="ç»´æŠ¤ä¸­">ç»´æŠ¤ä¸­</option>
                            <option value="ç¦»çº¿">ç¦»çº¿</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="category-filter">
                <div class="category-btn active" data-category="all" onclick="filterByCategory('all')">
                    å…¨éƒ¨è®¾å¤‡
                </div>
                <div class="category-btn" data-category="é…ç”µè®¾å¤‡" onclick="filterByCategory('é…ç”µè®¾å¤‡')">
                    <i class="fas fa-bolt me-1"></i> é…ç”µè®¾å¤‡
                </div>
                <div class="category-btn" data-category="å…‰ä¼è®¾å¤‡" onclick="filterByCategory('å…‰ä¼è®¾å¤‡')">
                    <i class="fas fa-solar-panel me-1"></i> å…‰ä¼è®¾å¤‡
                </div>
                <div class="category-btn" data-category="èƒ½è€—è®¾å¤‡" onclick="filterByCategory('èƒ½è€—è®¾å¤‡')">
                    <i class="fas fa-tachometer-alt me-1"></i> èƒ½è€—è®¾å¤‡
                </div>
            </div>
        </div>

        <!-- è®¾å¤‡ç»Ÿè®¡ -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="equipment-card text-center">
                    <div class="equipment-icon icon-electric mx-auto">
                        <i class="fas fa-bolt"></i>
                    </div>
                    <h3 id="totalEquipment">0</h3>
                    <p class="text-muted mb-0">è®¾å¤‡æ€»æ•°</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="equipment-card text-center">
                    <div class="equipment-icon icon-solar mx-auto">
                        <i class="fas fa-solar-panel"></i>
                    </div>
                    <h3 id="normalEquipment">0</h3>
                    <p class="text-muted mb-0">æ­£å¸¸è¿è¡Œ</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="equipment-card text-center">
                    <div class="equipment-icon icon-water mx-auto">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <h3 id="faultEquipment">0</h3>
                    <p class="text-muted mb-0">æ•…éšœè®¾å¤‡</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="equipment-card text-center">
                    <div class="equipment-icon icon-gas mx-auto">
                        <i class="fas fa-tools"></i>
                    </div>
                    <h3 id="maintenanceEquipment">0</h3>
                    <p class="text-muted mb-0">ç»´æŠ¤ä¸­</p>
                </div>
            </div>
        </div>

        <!-- è®¾å¤‡åˆ—è¡¨ -->
        <div id="equipmentList">
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">åŠ è½½ä¸­...</span>
                </div>
                <p class="mt-3">æ­£åœ¨åŠ è½½è®¾å¤‡æ•°æ®...</p>
            </div>
        </div>
    </div>

    <!-- è®¾å¤‡è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div class="modal fade" id="detailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">è®¾å¤‡è¯¦æƒ…</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">è®¾å¤‡ç¼–å·</label>
                                <input type="text" class="form-control" id="detailId" readonly>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">è®¾å¤‡åç§°</label>
                                <input type="text" class="form-control" id="detailName" readonly>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">è®¾å¤‡ç±»å‹</label>
                                <input type="text" class="form-control" id="detailType" readonly>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">è®¾å¤‡å¤§ç±»</label>
                                <input type="text" class="form-control" id="detailCategory" readonly>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">è¿è¡ŒçŠ¶æ€</label>
                                <div>
                                    <span class="equipment-status" id="detailStatus"></span>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">å®‰è£…ä½ç½®</label>
                                <input type="text" class="form-control" id="detailLocation" readonly>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">å®‰è£…æ—¶é—´</label>
                                <input type="text" class="form-control" id="detailInstallTime" readonly>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">è´¨ä¿æœŸ</label>
                                <input type="text" class="form-control" id="detailWarranty" readonly>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4">
                        <h6>ç»´æŠ¤è®°å½•</h6>
                        <div id="maintenanceRecords" class="bg-light p-3 rounded">
                            æš‚æ— ç»´æŠ¤è®°å½•
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // APIåŸºç¡€URL
        const API_BASE = '/api';

        // å…¨å±€å˜é‡
        let allEquipment = [];
        let currentCategory = 'all';

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        checkLogin();

        // é€€å‡ºç™»å½•
        document.getElementById('logoutBtn').addEventListener('click', logout);

        // åŠ è½½è®¾å¤‡æ•°æ®
        loadEquipment();

        // å‡½æ•°å®šä¹‰
        // æ›¿æ¢åŸæ¥çš„ checkLogin å‡½æ•°
function checkLogin() {
    verifyLogin();
}

async function verifyLogin() {
    try {
        const response = await fetch('/api/check-login', {
            method: 'GET',
            credentials: 'include'
        });

        if (!response.ok) {
            window.location.href = '/login';
            return;
        }

        const result = await response.json();

        if (result.success) {
            // å·²ç™»å½•ï¼Œå¯ä»¥ç»§ç»­åŠ è½½é¡µé¢æ•°æ®
            console.log('ç”¨æˆ·å·²ç™»å½•:', result.data.real_name);

            // æ ¹æ®é¡µé¢éœ€è¦ï¼Œå¯èƒ½è¿˜è¦æ›´æ–°ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º
            if (document.getElementById('userName')) {
                document.getElementById('userName').textContent = result.data.real_name || 'è¿ç»´äººå‘˜';
            }
            if (document.getElementById('userRealName')) {
                document.getElementById('userRealName').textContent = result.data.real_name || 'è¿ç»´äººå‘˜';
            }

            return result.data; // è¿”å›ç”¨æˆ·ä¿¡æ¯ï¼Œä¾›åç»­ä½¿ç”¨
        } else {
            window.location.href = '/login';
            return null;
        }
    } catch (error) {
        console.error('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', error);
        window.location.href = '/login';
        return null;
    }
}

        async function loadEquipment() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/operation/equipment`, {
                    headers: { 'Authorization': token }
                });

                if (response.status === 401) {
                    localStorage.clear();
                    window.location.href = 'index.html';
                    return;
                }

                const result = await response.json();

                if (result.success) {
                    allEquipment = result.data;
                    updateStatistics();
                    renderEquipment();
                    await updateAlertBadge();
                } else {
                    showError('åŠ è½½è®¾å¤‡å¤±è´¥');
                }
            } catch (error) {
                console.error('åŠ è½½è®¾å¤‡å¤±è´¥:', error);
                showError('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥');
            }
        }

        function updateStatistics() {
            const total = allEquipment.length;
            const normal = allEquipment.filter(e => e.è¿è¡ŒçŠ¶æ€ === 'æ­£å¸¸').length;
            const fault = allEquipment.filter(e => e.è¿è¡ŒçŠ¶æ€ === 'æ•…éšœ').length;
            const maintenance = allEquipment.filter(e => e.è¿è¡ŒçŠ¶æ€ === 'ç»´æŠ¤ä¸­').length;

            document.getElementById('totalEquipment').textContent = total;
            document.getElementById('normalEquipment').textContent = normal;
            document.getElementById('faultEquipment').textContent = fault;
            document.getElementById('maintenanceEquipment').textContent = maintenance;
        }

        function filterByCategory(category) {
            currentCategory = category;

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.category === category) {
                    btn.classList.add('active');
                }
            });

            renderEquipment();
        }

        function filterEquipment() {
            renderEquipment();
        }

        function renderEquipment() {
            let filteredEquipment = [...allEquipment];

            // æŒ‰ç±»åˆ«è¿‡æ»¤
            if (currentCategory !== 'all') {
                filteredEquipment = filteredEquipment.filter(e => e.è®¾å¤‡å¤§ç±» === currentCategory);
            }

            // æŒ‰æœç´¢è¯è¿‡æ»¤
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            if (searchTerm) {
                filteredEquipment = filteredEquipment.filter(e =>
                    (e.è®¾å¤‡åç§° && e.è®¾å¤‡åç§°.toLowerCase().includes(searchTerm)) ||
                    (e.è®¾å¤‡ç¼–å· && e.è®¾å¤‡ç¼–å·.toLowerCase().includes(searchTerm))
                );
            }

            // æŒ‰çŠ¶æ€è¿‡æ»¤
            const statusFilter = document.getElementById('statusFilter').value;
            if (statusFilter !== 'all') {
                filteredEquipment = filteredEquipment.filter(e => e.è¿è¡ŒçŠ¶æ€ === statusFilter);
            }

            const container = document.getElementById('equipmentList');

            if (filteredEquipment.length === 0) {
                container.innerHTML = `
                <div class="text-center py-5">
                    <i class="fas fa-cogs fa-3x text-muted mb-3"></i>
                    <h4 class="text-muted">æš‚æ— è®¾å¤‡</h4>
                    <p class="text-muted">å½“å‰ç­›é€‰æ¡ä»¶ä¸‹æ²¡æœ‰è®¾å¤‡è®°å½•</p>
                </div>
                `;
                return;
            }

            let html = '<div class="row">';

            filteredEquipment.forEach(equipment => {
                html += createEquipmentCard(equipment);
            });

            html += '</div>';
            container.innerHTML = html;
        }

        function createEquipmentCard(equipment) {
            // ç¡®å®šå›¾æ ‡å’Œæ ·å¼
            let iconClass, statusClass, statusText;

            if (equipment.è®¾å¤‡å¤§ç±» === 'é…ç”µè®¾å¤‡') {
                iconClass = 'icon-electric';
            } else if (equipment.è®¾å¤‡å¤§ç±» === 'å…‰ä¼è®¾å¤‡') {
                iconClass = 'icon-solar';
            } else if (equipment.è®¾å¤‡å¤§ç±» === 'èƒ½è€—è®¾å¤‡') {
                iconClass = 'icon-water';
            } else {
                iconClass = 'icon-gas';
            }

            // ç¡®å®šçŠ¶æ€æ ·å¼
            if (equipment.è¿è¡ŒçŠ¶æ€ === 'æ­£å¸¸') {
                statusClass = 'status-normal';
                statusText = 'æ­£å¸¸';
            } else if (equipment.è¿è¡ŒçŠ¶æ€ === 'æ•…éšœ') {
                statusClass = 'status-fault';
                statusText = 'æ•…éšœ';
            } else if (equipment.è¿è¡ŒçŠ¶æ€ === 'ç»´æŠ¤ä¸­') {
                statusClass = 'status-maintenance';
                statusText = 'ç»´æŠ¤ä¸­';
            } else {
                statusClass = 'status-offline';
                statusText = 'ç¦»çº¿';
            }

            return `
            <div class="col-md-4">
                <div class="equipment-card">
                    <div class="d-flex align-items-start mb-3">
                        <div class="${iconClass}">
                            <i class="fas fa-${getEquipmentIcon(equipment.è®¾å¤‡ç±»å‹)}"></i>
                        </div>
                        <div class="ms-3 flex-grow-1">
                            <h5 class="mb-1">${equipment.è®¾å¤‡åç§°}</h5>
                            <p class="text-muted mb-0">${equipment.è®¾å¤‡ç¼–å·}</p>
                        </div>
                        <div>
                            <span class="equipment-status ${statusClass}">${statusText}</span>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="row">
                            <div class="col-6">
                                <small class="text-muted d-block">è®¾å¤‡ç±»å‹</small>
                                <strong>${equipment.è®¾å¤‡ç±»å‹ || 'æœªåˆ†ç±»'}</strong>
                            </div>
                            <div class="col-6">
                                <small class="text-muted d-block">å®‰è£…æ—¶é—´</small>
                                <strong>${equipment.å®‰è£…æ—¶é—´ ? equipment.å®‰è£…æ—¶é—´.split('T')[0] : 'æœªçŸ¥'}</strong>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <small class="text-muted d-block">å®‰è£…ä½ç½®</small>
                        <p class="mb-0">${equipment.å®‰è£…ä½ç½®æè¿° || 'æœªè®°å½•'}</p>
                    </div>

                    <div class="d-flex justify-content-between align-items-center">
                        <span class="badge bg-light text-dark">
                            ${equipment.è´¨ä¿æœŸ ? `è´¨ä¿${equipment.è´¨ä¿æœŸ}å¹´` : 'æ— è´¨ä¿'}
                        </span>
                        <div>
                            <button class="btn btn-sm btn-outline-primary"
                                    onclick="showEquipmentDetail('${equipment.è®¾å¤‡ç¼–å·}')">
                                <i class="fas fa-info-circle"></i> è¯¦æƒ…
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            `;
        }

        function getEquipmentIcon(type) {
            const iconMap = {
                'å˜å‹å™¨': 'bolt',
                'é…ç”µå›è·¯': 'plug',
                'é€†å˜å™¨': 'solar-panel',
                'æ±‡æµç®±': 'stream',
                'æ°´è¡¨': 'tint',
                'å¤©ç„¶æ°”è¡¨': 'fire',
                'è’¸æ±½è¡¨': 'thermometer-half'
            };
            return iconMap[type] || 'cog';
        }

        function showEquipmentDetail(equipmentId) {
            const equipment = allEquipment.find(e => e.è®¾å¤‡ç¼–å· === equipmentId);
            if (!equipment) return;

            // å¡«å……è¯¦æƒ…æ•°æ®
            document.getElementById('detailId').value = equipment.è®¾å¤‡ç¼–å·;
            document.getElementById('detailName').value = equipment.è®¾å¤‡åç§°;
            document.getElementById('detailType').value = equipment.è®¾å¤‡ç±»å‹ || 'æœªåˆ†ç±»';
            document.getElementById('detailCategory').value = equipment.è®¾å¤‡å¤§ç±» || 'æœªåˆ†ç±»';
            document.getElementById('detailLocation').value = equipment.å®‰è£…ä½ç½®æè¿° || 'æœªè®°å½•';
            document.getElementById('detailInstallTime').value = equipment.å®‰è£…æ—¶é—´ ?
                equipment.å®‰è£…æ—¶é—´.split('T')[0] : 'æœªçŸ¥';
            document.getElementById('detailWarranty').value = equipment.è´¨ä¿æœŸ ?
                `${equipment.è´¨ä¿æœŸ}å¹´` : 'æ— è´¨ä¿';

            // è®¾ç½®çŠ¶æ€
            const statusSpan = document.getElementById('detailStatus');
            statusSpan.className = 'equipment-status ';
            if (equipment.è¿è¡ŒçŠ¶æ€ === 'æ­£å¸¸') {
                statusSpan.classList.add('status-normal');
                statusSpan.textContent = 'æ­£å¸¸';
            } else if (equipment.è¿è¡ŒçŠ¶æ€ === 'æ•…éšœ') {
                statusSpan.classList.add('status-fault');
                statusSpan.textContent = 'æ•…éšœ';
            } else if (equipment.è¿è¡ŒçŠ¶æ€ === 'ç»´æŠ¤ä¸­') {
                statusSpan.classList.add('status-maintenance');
                statusSpan.textContent = 'ç»´æŠ¤ä¸­';
            } else {
                statusSpan.classList.add('status-offline');
                statusSpan.textContent = 'ç¦»çº¿';
            }

            // æ˜¾ç¤ºç»´æŠ¤è®°å½•
            const recordsDiv = document.getElementById('maintenanceRecords');
            recordsDiv.innerHTML = equipment.ç»´ä¿®è®°å½• || 'æš‚æ— ç»´æŠ¤è®°å½•';

            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            const modal = new bootstrap.Modal(document.getElementById('detailModal'));
            modal.show();
        }

        function refreshEquipment() {
            loadEquipment();
            updateAlertBadge();
            showMessage('æ­£åœ¨åˆ·æ–°æ•°æ®...', 'info');
        }

        async function logout() {
            try {
                const token = localStorage.getItem('token');
                await fetch(`${API_BASE}/logout`, {
                    method: 'POST',
                    headers: { 'Authorization': token }
                });
            } catch (error) {
                console.error('é€€å‡ºç™»å½•å¤±è´¥:', error);
            } finally {
                localStorage.clear();
                window.location.href = '/login';
            }
        }

        function showMessage(message, type = 'info') {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alert.style.cssText = `
                top: 20px;
                right: 20px;
                z-index: 9999;
                min-width: 300px;
            `;
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            document.body.appendChild(alert);

            setTimeout(() => {
                alert.remove();
            }, 3000);
        }

        function showError(message) {
            const container = document.getElementById('equipmentList');
            container.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                ${message}
                <button class="btn btn-sm btn-outline-danger float-end" onclick="loadEquipment()">
                    é‡è¯•
                </button>
            </div>
            `;
        }

        // é€šç”¨å‡½æ•° - æ›´æ–°å‘Šè­¦å¾½ç« 
        async function updateAlertBadge() {
            try {
                const token = localStorage.getItem('token');

                // è·å–æœªå¤„ç†çš„å‘Šè­¦æ•°é‡
                const response = await fetch(`${API_BASE}/alert-badge`, {
                    headers: { 'Authorization': token }
                });

                if (response.ok) {
                    const result = await response.json();
                    const count = result.count || 0;

                    // æ›´æ–°æ‰€æœ‰é¡µé¢ä¸­çš„å‘Šè­¦å¾½ç« 
                    const badges = document.querySelectorAll('#alertBadge, .alert-badge');
                    badges.forEach(badge => {
                        badge.textContent = count;
                        badge.style.display = count > 0 ? 'inline' : 'none';
                    });

                    return count;
                }
                return 0;
            } catch (error) {
                console.error('æ›´æ–°å‘Šè­¦å¾½ç« å¤±è´¥:', error);
                return 0;
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ›´æ–°å‘Šè­¦å¾½ç« 
        document.addEventListener('DOMContentLoaded', function() {
            updateAlertBadge();

            // è®¾ç½®å®šæœŸæ›´æ–°ï¼ˆæ¯30ç§’ï¼‰
            setInterval(updateAlertBadge, 30000);

            // é¡µé¢è·å¾—ç„¦ç‚¹æ—¶æ›´æ–°
            document.addEventListener('visibilitychange', function() {
                if (!document.hidden) {
                    updateAlertBadge();
                }
            });
        });
        async function runDebug() {
    try {
        console.log('ğŸ” å¼€å§‹è°ƒè¯•...');

        // 1. è·å–è°ƒè¯•ä¿¡æ¯
        const debugResponse = await fetch(`${API_BASE}/debug/equipment-debug`, {
            method: 'GET',
            credentials: 'include'
        });

        if (debugResponse.ok) {
            const debugResult = await debugResponse.json();
            console.log('ğŸ” è°ƒè¯•ä¿¡æ¯:', debugResult);

            // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
            const debugInfo = debugResult.debug_info;
            alert(`è°ƒè¯•ä¿¡æ¯ï¼š
ç”¨æˆ·: ${debugInfo.user_info?.çœŸå®å§“å}
ç”¨æˆ·è§’è‰²: ${debugInfo.user_info?.ç”¨æˆ·è§’è‰²}
Sessionå‚åŒºID: ${debugInfo.session_factory_id}
æ•°æ®åº“å‚åŒºID: ${debugInfo.user_factory_id}
å‚åŒºè®¾å¤‡æ•°é‡: ${debugInfo.equipment_count_in_factory}

æ•°æ®åº“ä¸­å„å‚åŒºè®¾å¤‡åˆ†å¸ƒ:
${debugInfo.equipment_by_factory?.map(item =>
    `å‚åŒº ${item.æ‰€å±å‚åŒºç¼–å·}: ${item.device_count} å°è®¾å¤‡`
).join('\n') || 'æ— æ•°æ®'}
            `);
        }

        // 2. æ£€æŸ¥å½“å‰æŸ¥è¯¢ç»“æœ
        console.log('ğŸ” å½“å‰è®¾å¤‡æ•°æ®:', allEquipment);
        console.log(`ğŸ” å½“å‰è®¾å¤‡æ•°é‡: ${allEquipment.length}`);

        // 3. æ˜¾ç¤ºè®¾å¤‡å‚åŒºåˆ†å¸ƒ
        const factoryDistribution = {};
        allEquipment.forEach(device => {
            // æ³¨æ„ï¼šè¿™é‡Œå¯èƒ½éœ€è¦æ ¹æ®ä½ çš„æ•°æ®ç»“æ„è°ƒæ•´
            const factory = device.æ‰€å±å‚åŒºç¼–å· || device.å‚åŒºåç§° ;
            factoryDistribution[factory] = (factoryDistribution[factory] || 0) + 1;
        });

        console.log('ğŸ” è®¾å¤‡å‚åŒºåˆ†å¸ƒ:', factoryDistribution);

    } catch (error) {
        console.error('âŒ è°ƒè¯•å¤±è´¥:', error);
        alert(`è°ƒè¯•å¤±è´¥: ${error.message}`);
    }
}
    </script>
</body>
</html>