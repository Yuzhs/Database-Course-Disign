{% extends "workorder/base.html" %}

{% block title %}控制面板 - 智慧能源管理系统{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2><i class="fas fa-tachometer-alt me-2"></i> 控制面板</h2>
        <p class="text-muted">欢迎使用智慧能源管理系统，{{ session.real_name }}！</p>
    </div>
</div>

<!-- 统计卡片 -->
<div class="row">
    <div class="col-md-4">
        <div class="stat-card bg-alarm shadow">
            <h5><i class="fas fa-exclamation-triangle me-2"></i> 告警统计</h5>
            <h2 class="display-4">{{ alarm_stats.total_alarms or 0 }}</h2>
            <div class="row">
                <div class="col-6">
                    <small>待审核: {{ alarm_stats.pending_review_alarms or 0 }}</small>
                </div>
                <div class="col-6">
                    <small>高优先级: {{ alarm_stats.high_priority_alarms or 0 }}</small>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="stat-card bg-order shadow">
            <h5><i class="fas fa-tasks me-2"></i> 工单统计</h5>
            <h2 class="display-4">{{ order_stats.total_orders or 0 }}</h2>
            <div class="row">
                <div class="col-6">
                    <small>进行中: {{ order_stats.pending_orders or 0 }}</small>
                </div>
                <div class="col-6">
                    <small>待复查: {{ order_stats.failed_reviews or 0 }}</small>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="stat-card bg-review shadow">
            <h5><i class="fas fa-user-check me-2"></i> 我的任务</h5>
            <h2 class="display-4">0</h2>
            <div class="row">
                <div class="col-6">
                    <small>待审核告警: 0</small>
                </div>
                <div class="col-6">
                    <small>待复查工单: 0</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 快速操作 -->
<!-- 在快速操作部分修改 -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-bolt me-2"></i> 快速操作</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% if user_role == '运维工单管理员' %}
                    <div class="col-md-3 mb-3">
                        <a href="{{ url_for('workorder_alarms') }}?status=待审核" class="btn btn-primary w-100">
                            <i class="fas fa-check-circle me-2"></i> 审核待处理告警
                            <span class="badge bg-white text-primary ms-2">{{ alarm_stats.pending_review_alarms or 0 }}</span>
                        </a>
                    </div>
                    <div class="col-md-3 mb-3">
                        <a href="{{ url_for('workorder_alarms') }}?status=未处理" class="btn btn-warning w-100">
                            <i class="fas fa-tasks me-2"></i> 处理未处理告警
                            <span class="badge bg-white text-warning ms-2">{{ alarm_stats.pending_alarms or 0 }}</span>
                        </a>
                    </div>
                    <div class="col-md-3 mb-3">
                        <a href="{{ url_for('workorder_work_orders') }}?status=pending" class="btn btn-info w-100">
                            <i class="fas fa-clock me-2"></i> 进行中工单
                        </a>
                    </div>
                    <div class="col-md-3 mb-3">
                        <a href="{{ url_for('workorder_work_orders') }}?review_status=未通过" class="btn btn-secondary w-100">
                            <i class="fas fa-redo me-2"></i> 复查未通过
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 最近告警 -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-history me-2"></i> 最近告警</h5>
            </div>
            <div class="card-body">
                {% if recent_alarms %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>告警ID</th>
                                <th>类型</th>
                                <th>等级</th>
                                <th>设备</th>
                                <th>发生时间</th>
                                <th>状态</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for alarm in recent_alarms %}
                            <tr>
                                <td>{{ alarm.告警编号 }}</td>
                                <td>{{ alarm.告警类型 }}</td>
                                <td>
                                    {% if alarm.告警等级 == '高' %}
                                    <span class="badge badge-critical">高</span>
                                    {% elif alarm.告警等级 == '中' %}
                                    <span class="badge badge-warning">中</span>
                                    {% else %}
                                    <span class="badge badge-info">低</span>
                                    {% endif %}
                                </td>
                                <td>{{ alarm.设备名称 or 'N/A' }}</td>
                                <td>{{ alarm.发生时间.strftime('%Y-%m-%d %H:%M') if alarm.发生时间 else 'N/A' }}</td>
                                <td>
                                    {% if alarm.处理状态 == '未处理' %}
                                    <span class="badge bg-danger">未处理</span>
                                    {% elif alarm.处理状态 == '待审核' %}
                                    <span class="badge bg-danger">待审核</span>
                                    {% elif alarm.处理状态 == '待决策' %}
                                    <span class="badge bg-danger">待决策</span>
                                    {% elif alarm.处理状态 == '处理中' %}
                                    <span class="badge bg-warning">处理中</span>
                                    {% else %}
                                    <span class="badge bg-success">已结案</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="{{ url_for('workorder_alarm_detail', alarm_id=alarm.告警ID) }}"
                                       class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                    <p class="text-muted">暂无告警信息</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // 更新告警数量
    function updateCounts() {
        $.ajax({
            url: '/api/get_counts',
            method: 'GET',
            success: function(data) {
                if (data.success) {
                    $('#alarm-count').text(data.pending_alarms);
                    $('#order-count').text(data.pending_orders);
                }
            }
        });
    }
    
    // 每30秒更新一次
    updateCounts();
    setInterval(updateCounts, 30000);
});
</script>
{% endblock %}