<!-- frontend/analyst.html -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºæ…§èƒ½æºç®¡ç†ç³»ç»Ÿ - æ•°æ®åˆ†æå¸ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: #f5f5f5;
        }

        .header {
            background: white;
            padding: 15px 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo h1 {
            color: #333;
            font-size: 20px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logout-btn {
            padding: 8px 15px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .sidebar {
            width: 250px;
            background: white;
            height: calc(100vh - 60px);
            position: fixed;
            padding: 20px 0;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            padding: 15px 25px;
            cursor: pointer;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-item:hover, .nav-item.active {
            background: #667eea;
            color: white;
        }

        .content {
            margin-left: 250px;
            padding: 30px;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .card h2 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-group label {
            font-size: 14px;
            color: #666;
        }

        .control-group input, .control-group select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .btn {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #5a67d8;
        }

        .chart-container {
            width: 100%;
            height: 400px;
            margin-top: 20px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table th, .data-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }

        .data-table th {
            background: #f8f9fa;
            font-weight: 600;
        }

        .data-table tr:nth-child(even) {
            background: #f9f9f9;
        }

        .warning {
            color: #e74c3c;
            font-weight: bold;
        }

        .success {
            color: #2ecc71;
            font-weight: bold;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .report-section {
            margin-top: 30px;
        }

        .report-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">
            <h1>æ™ºæ…§èƒ½æºç®¡ç†ç³»ç»Ÿ - æ•°æ®åˆ†æå¸ˆå¹³å°</h1>
        </div>
        <div class="user-info">
            <span id="currentUser">æ­£åœ¨åŠ è½½ç”¨æˆ·ä¿¡æ¯...</span>
            <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
        </div>
    </div>

    <div class="sidebar">
        <ul class="nav-menu">
            <li class="nav-item active" onclick="showSection('dashboard')">
                <span>ğŸ“Š ä»ªè¡¨ç›˜</span>
            </li>
            <li class="nav-item" onclick="showSection('pv-analysis')">
                <span>â˜€ï¸ å…‰ä¼åˆ†æ</span>
            </li>
            <li class="nav-item" onclick="showSection('energy-analysis')">
                <span>âš¡ èƒ½è€—åˆ†æ</span>
            </li>
            <li class="nav-item" onclick="showSection('report')">
                <span>ğŸ“ˆ æŠ¥å‘Šç”Ÿæˆ</span>
            </li>
            <li class="nav-item" onclick="showSection('optimization')">
                <span>ğŸ”§ æ¨¡å‹ä¼˜åŒ–</span>
            </li>
        </ul>
    </div>

    <div class="content">
        <!-- ä»ªè¡¨ç›˜ -->
        <div id="dashboard" class="section">
            <div class="card">
                <h2>æ•°æ®æ€»è§ˆ</h2>
                <div id="dashboardLoading" class="loading">æ­£åœ¨åŠ è½½ä»ªè¡¨ç›˜æ•°æ®...</div>
                <div id="dashboardContent" style="display: none;">
                    <div class="controls">
                        <div class="control-group">
                            <label>æ—¶é—´èŒƒå›´</label>
                            <select id="dashboardRange">
                                <option value="7">æœ€è¿‘7å¤©</option>
                                <option value="30" selected>æœ€è¿‘30å¤©</option>
                                <option value="90">æœ€è¿‘90å¤©</option>
                            </select>
                        </div>
                        <button class="btn" onclick="loadDashboard()">åˆ·æ–°æ•°æ®</button>
                    </div>

                    <div class="chart-container">
                        <div id="pvChart" style="height: 300px;"></div>
                    </div>

                    <div class="chart-container">
                        <div id="energyChart" style="height: 300px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å…‰ä¼åˆ†æ -->
        <div id="pv-analysis" class="section" style="display: none;">
            <div class="card">
                <h2>å…‰ä¼é¢„æµ‹åˆ†æ</h2>
                <div class="controls">
                    <div class="control-group">
                        <label>å¼€å§‹æ—¥æœŸ</label>
                        <input type="date" id="pvStartDate">
                    </div>
                    <div class="control-group">
                        <label>ç»“æŸæ—¥æœŸ</label>
                        <input type="date" id="pvEndDate">
                    </div>
                    <button class="btn" onclick="analyzePV()">å¼€å§‹åˆ†æ</button>
                </div>

                <div id="pvResult">
                    <div class="loading">è¯·é€‰æ‹©æ—¥æœŸèŒƒå›´å¹¶å¼€å§‹åˆ†æ</div>
                </div>
            </div>
        </div>

        <!-- èƒ½è€—åˆ†æ -->
        <div id="energy-analysis" class="section" style="display: none;">
            <div class="card">
                <h2>èƒ½è€—æ¨¡å¼åˆ†æ</h2>
                <div class="controls">
                    <div class="control-group">
                        <label>å‚åŒº</label>
                        <select id="energyPlant">
                            <option value="">å…¨éƒ¨å‚åŒº</option>
                            <!-- åŠ¨æ€åŠ è½½å‚åŒº -->
                        </select>
                    </div>
                    <div class="control-group">
                        <label>å¼€å§‹æ—¥æœŸ</label>
                        <input type="date" id="energyStartDate">
                    </div>
                    <div class="control-group">
                        <label>ç»“æŸæ—¥æœŸ</label>
                        <input type="date" id="energyEndDate">
                    </div>
                    <button class="btn" onclick="analyzeEnergy()">å¼€å§‹åˆ†æ</button>
                </div>

                <div id="energyResult">
                    <div class="loading">è¯·é€‰æ‹©åˆ†ææ¡ä»¶</div>
                </div>
            </div>
        </div>

        <!-- æŠ¥å‘Šç”Ÿæˆ -->
        <div id="report" class="section" style="display: none;">
            <div class="card">
                <h2>èƒ½æºæŠ¥å‘Šç”Ÿæˆ</h2>
                <div class="controls">
                    <div class="control-group">
                        <label>æŠ¥å‘Šç±»å‹</label>
                        <select id="reportType">
                            <option value="monthly">æœˆåº¦æŠ¥å‘Š</option>
                            <option value="quarterly">å­£åº¦æŠ¥å‘Š</option>
                            <option value="yearly">å¹´åº¦æŠ¥å‘Š</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label>å¹´ä»½</label>
                        <input type="number" id="reportYear" value="2024" min="2020" max="2030">
                    </div>
                    <div class="control-group" id="monthGroup">
                        <label>æœˆä»½</label>
                        <select id="reportMonth">
                            <option value="1">1æœˆ</option>
                            <option value="2">2æœˆ</option>
                            <option value="3">3æœˆ</option>
                            <option value="4">4æœˆ</option>
                            <option value="5">5æœˆ</option>
                            <option value="6">6æœˆ</option>
                            <option value="7">7æœˆ</option>
                            <option value="8">8æœˆ</option>
                            <option value="9">9æœˆ</option>
                            <option value="10">10æœˆ</option>
                            <option value="11">11æœˆ</option>
                            <option value="12">12æœˆ</option>
                        </select>
                    </div>
                    <button class="btn" onclick="generateReport()">ç”ŸæˆæŠ¥å‘Š</button>
                </div>

                <div id="reportResult">
                    <div class="loading">è¯·é€‰æ‹©æŠ¥å‘Šå‚æ•°</div>
                </div>
            </div>
        </div>

        <!-- æ¨¡å‹ä¼˜åŒ– -->
        <div id="optimization" class="section" style="display: none;">
            <div class="card">
                <h2>é¢„æµ‹æ¨¡å‹ä¼˜åŒ–</h2>
                <div class="controls">
                    <div class="control-group">
                        <label>åå·®ç‡é˜ˆå€¼ (%)</label>
                        <input type="number" id="deviationThreshold" value="15" min="0" max="100">
                    </div>
                    <button class="btn" onclick="optimizeModel()">å¼€å§‹ä¼˜åŒ–</button>
                </div>

                <div id="optimizationResult">
                    <div class="loading">è¯·è¾“å…¥åå·®ç‡é˜ˆå€¼å¹¶å¼€å§‹ä¼˜åŒ–</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentUser = null;
        let pvChart = null;
        let energyChart = null;

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        // document.addEventListener('DOMContentLoaded', function() {
        //     // è·å–ç”¨æˆ·ä¿¡æ¯
        //     fetch('/current_user')
        //         .then(response => response.json())
        //         .then(data => {
        //             if (data.success) {
        //                 currentUser = data.user;
        //                 document.getElementById('currentUser').textContent =
        //                     `${currentUser.realname} (${currentUser.role})`;
        //
        //                 // å¦‚æœä¸æ˜¯æ•°æ®åˆ†æå¸ˆï¼Œè·³å›é¦–é¡µ
        //                 if (currentUser.role !== 'æ•°æ®åˆ†æå¸ˆ') {
        //                     window.location.href = '/';
        //                 } else {
        //                     // åˆå§‹åŒ–æ—¥æœŸ
        //                     initDates();
        //                     // åŠ è½½ä»ªè¡¨ç›˜
        //                     loadDashboard();
        //                 }
        //             } else {
        //                 window.location.href = '/';
        //             }
        //         })
        //         .catch(error => {
        //             console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
        //             window.location.href = '/';
        //         });
        // });

        document.addEventListener('DOMContentLoaded', function() {
    // è·å–ç”¨æˆ·ä¿¡æ¯
    fetch('/current_user')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                currentUser = data.user;
                document.getElementById('currentUser').textContent =
                    `${currentUser.name} (${currentUser.role})`;

                // å¦‚æœä¸æ˜¯æ•°æ®åˆ†æå¸ˆï¼Œè·³å›é¦–é¡µ
                if (currentUser.role !== 'æ•°æ®åˆ†æå¸ˆ') {
                    window.location.href = '/dashboard';
                } else {
                    // åˆå§‹åŒ–æ—¥æœŸ
                    initDates();
                    // åŠ è½½ä»ªè¡¨ç›˜
                    loadDashboard();
                }
            } else {
                // æœªç™»å½•æˆ–ä¼šè¯è¿‡æœŸï¼Œè·³è½¬åˆ°ç™»å½•é¡µ
                window.location.href = '/login';
            }
        })
        .catch(error => {
            console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
            window.location.href = '/login';
        });
});

        // åˆå§‹åŒ–æ—¥æœŸæ§ä»¶
        function initDates() {
            const today = new Date();
            const oneMonthAgo = new Date();
            oneMonthAgo.setMonth(today.getMonth() - 1);

            // æ ¼å¼åŒ–æ—¥æœŸä¸ºYYYY-MM-DD
            const formatDate = (date) => {
                return date.toISOString().split('T')[0];
            };

            document.getElementById('pvStartDate').value = formatDate(oneMonthAgo);
            document.getElementById('pvEndDate').value = formatDate(today);

            document.getElementById('energyStartDate').value = formatDate(oneMonthAgo);
            document.getElementById('energyEndDate').value = formatDate(today);

            document.getElementById('reportYear').value = today.getFullYear();
            document.getElementById('reportMonth').value = today.getMonth() + 1;
        }

        // åˆ‡æ¢é¡µé¢éƒ¨åˆ†
        function showSection(sectionId) {
            // éšè—æ‰€æœ‰éƒ¨åˆ†
            document.querySelectorAll('.section').forEach(section => {
                section.style.display = 'none';
            });

            // ç§»é™¤æ‰€æœ‰æ´»åŠ¨çš„å¯¼èˆªé¡¹
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });

            // æ˜¾ç¤ºé€‰ä¸­çš„éƒ¨åˆ†
            document.getElementById(sectionId).style.display = 'block';

            // æ¿€æ´»å¯¹åº”çš„å¯¼èˆªé¡¹
            document.querySelectorAll('.nav-item').forEach(item => {
                if (item.textContent.includes(getSectionTitle(sectionId))) {
                    item.classList.add('active');
                }
            });

            // æ ¹æ®éƒ¨åˆ†åŠ è½½æ•°æ®
            switch(sectionId) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'pv-analysis':
                    // å…‰ä¼åˆ†æé¡µé¢å·²ç»å¯ä»¥åˆ†æ
                    break;
                case 'energy-analysis':
                    // èƒ½è€—åˆ†æé¡µé¢å·²ç»å¯ä»¥åˆ†æ
                    break;
                case 'report':
                    // æŠ¥å‘Šç”Ÿæˆé¡µé¢å·²ç»å¯ä»¥ç”Ÿæˆ
                    break;
                case 'optimization':
                    // æ¨¡å‹ä¼˜åŒ–é¡µé¢å·²ç»å¯ä»¥ä¼˜åŒ–
                    break;
            }
        }

        function getSectionTitle(sectionId) {
            const titles = {
                'dashboard': 'ä»ªè¡¨ç›˜',
                'pv-analysis': 'å…‰ä¼åˆ†æ',
                'energy-analysis': 'èƒ½è€—åˆ†æ',
                'report': 'æŠ¥å‘Šç”Ÿæˆ',
                'optimization': 'æ¨¡å‹ä¼˜åŒ–'
            };
            return titles[sectionId] || '';
        }

        // åŠ è½½ä»ªè¡¨ç›˜æ•°æ®
        async function loadDashboard() {
            const dashboardLoading = document.getElementById('dashboardLoading');
            const dashboardContent = document.getElementById('dashboardContent');

            dashboardLoading.style.display = 'block';
            dashboardContent.style.display = 'none';

            try {
                const response = await fetch('/api/analyst/dashboard');
                const data = await response.json();

                if (data.success) {
                    displayDashboardData(data.data);
                    dashboardLoading.style.display = 'none';
                    dashboardContent.style.display = 'block';
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                dashboardLoading.innerHTML = `<div class="error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æ˜¾ç¤ºä»ªè¡¨ç›˜æ•°æ®
        function displayDashboardData(data) {
            // æ˜¾ç¤ºå…‰ä¼æ•°æ®å›¾è¡¨
            displayPVChart(data.pv_analysis);

            // æ˜¾ç¤ºèƒ½è€—æ•°æ®å›¾è¡¨
            displayEnergyChart(data.energy_analysis);
        }

        // æ˜¾ç¤ºå…‰ä¼å›¾è¡¨
        function displayPVChart(pvData) {
            if (!pvData || !pvData.predictions) return;

            const chartDom = document.getElementById('pvChart');
            if (pvChart) {
                pvChart.dispose();
            }
            pvChart = echarts.init(chartDom);

            // å‡†å¤‡æ•°æ®
            const dates = pvData.predictions.map(p => p.é¢„æµ‹æ—¥æœŸ);
            const predicted = pvData.predictions.map(p => p.é¢„æµ‹å‘ç”µé‡);
            const actual = pvData.predictions.map(p => p.å®é™…å‘ç”µé‡);

            const option = {
                title: {
                    text: 'å…‰ä¼å‘ç”µé¢„æµ‹ vs å®é™…',
                    left: 'center'
                },
                tooltip: {
                    trigger: 'axis'
                },
                legend: {
                    data: ['é¢„æµ‹å‘ç”µé‡', 'å®é™…å‘ç”µé‡'],
                    top: 30
                },
                xAxis: {
                    type: 'category',
                    data: dates
                },
                yAxis: {
                    type: 'value',
                    name: 'å‘ç”µé‡ (kWh)'
                },
                series: [
                    {
                        name: 'é¢„æµ‹å‘ç”µé‡',
                        type: 'line',
                        data: predicted,
                        smooth: true,
                        lineStyle: {
                            color: '#5470c6'
                        }
                    },
                    {
                        name: 'å®é™…å‘ç”µé‡',
                        type: 'line',
                        data: actual,
                        smooth: true,
                        lineStyle: {
                            color: '#91cc75'
                        }
                    }
                ]
            };

            pvChart.setOption(option);
        }

        // æ˜¾ç¤ºèƒ½è€—å›¾è¡¨
        function displayEnergyChart(energyData) {
            if (!energyData || !energyData.energy_by_type) return;

            const chartDom = document.getElementById('energyChart');
            if (energyChart) {
                energyChart.dispose();
            }
            energyChart = echarts.init(chartDom);

            const energyTypes = Object.keys(energyData.energy_by_type);
            const energyValues = energyTypes.map(type => energyData.energy_by_type[type].total_energy);
            const energyCosts = energyTypes.map(type => energyData.energy_by_type[type].total_cost);

            const option = {
                title: {
                    text: 'èƒ½æºæ¶ˆè€—åˆ†æ',
                    left: 'center'
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'shadow'
                    }
                },
                legend: {
                    data: ['èƒ½è€—é‡', 'æˆæœ¬'],
                    top: 30
                },
                xAxis: [
                    {
                        type: 'category',
                        data: energyTypes
                    }
                ],
                yAxis: [
                    {
                        type: 'value',
                        name: 'èƒ½è€—é‡',
                        position: 'left'
                    },
                    {
                        type: 'value',
                        name: 'æˆæœ¬ (å…ƒ)',
                        position: 'right'
                    }
                ],
                series: [
                    {
                        name: 'èƒ½è€—é‡',
                        type: 'bar',
                        data: energyValues,
                        yAxisIndex: 0,
                        itemStyle: {
                            color: '#5470c6'
                        }
                    },
                    {
                        name: 'æˆæœ¬',
                        type: 'line',
                        data: energyCosts,
                        yAxisIndex: 1,
                        lineStyle: {
                            color: '#ee6666'
                        }
                    }
                ]
            };

            energyChart.setOption(option);
        }

        // å…‰ä¼åˆ†æ
        async function analyzePV() {
            const startDate = document.getElementById('pvStartDate').value;
            const endDate = document.getElementById('pvEndDate').value;

            if (!startDate || !endDate) {
                alert('è¯·é€‰æ‹©å¼€å§‹æ—¥æœŸå’Œç»“æŸæ—¥æœŸ');
                return;
            }

            const resultDiv = document.getElementById('pvResult');
            resultDiv.innerHTML = '<div class="loading">æ­£åœ¨åˆ†ææ•°æ®...</div>';

            try {
                const response = await fetch(`/api/analyst/pv-analysis?start_date=${startDate}&end_date=${endDate}`);
                const data = await response.json();

                if (data.success) {
                    displayPVAnalysisResult(data.data);
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">åˆ†æå¤±è´¥: ${error.message}</div>`;
            }
        }

        function displayPVAnalysisResult(data) {
            let html = `
                <div class="report-section">
                    <h3>åˆ†æç»“æœæ¦‚è§ˆ</h3>
                    <div class="report-item">
                        <p>åˆ†ææ—¶é—´æ®µ: ${data.predictions[0]?.é¢„æµ‹æ—¥æœŸ || ''} è‡³ ${data.predictions[data.predictions.length-1]?.é¢„æµ‹æ—¥æœŸ || ''}</p>
                        <p>æ€»é¢„æµ‹æ¬¡æ•°: ${data.total_predictions}</p>
                        <p>é«˜åå·®é¢„æµ‹æ•°: <span class="warning">${data.high_deviation_count}</span> (${data.high_deviation_percentage.toFixed(2)}%)</p>
                        <p>å¹³å‡åå·®ç‡: ${data.average_deviation.toFixed(2)}%</p>
                        <p>æœ€å¤§åå·®ç‡: ${data.max_deviation.åå·®ç‡?.toFixed(2) || 0}% (${data.max_deviation.é¢„æµ‹æ—¥æœŸ || ''})</p>
                    </div>

                    <h3 style="margin-top: 20px;">è¯¦ç»†é¢„æµ‹æ•°æ®</h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>é¢„æµ‹ç¼–å·</th>
                                <th>æ—¥æœŸ</th>
                                <th>é¢„æµ‹å‘ç”µé‡ (kWh)</th>
                                <th>å®é™…å‘ç”µé‡ (kWh)</th>
                                <th>åå·®ç‡ (%)</th>
                                <th>çŠ¶æ€</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            data.predictions.forEach(prediction => {
                const statusClass = prediction.éœ€è¦ä¼˜åŒ– ? 'warning' : 'success';
                const statusText = prediction.éœ€è¦ä¼˜åŒ– ? 'éœ€è¦ä¼˜åŒ–' : 'æ­£å¸¸';

                html += `
                    <tr>
                        <td>${prediction.é¢„æµ‹ç¼–å·}</td>
                        <td>${prediction.é¢„æµ‹æ—¥æœŸ}</td>
                        <td>${prediction.é¢„æµ‹å‘ç”µé‡.toFixed(2)}</td>
                        <td>${prediction.å®é™…å‘ç”µé‡.toFixed(2)}</td>
                        <td>${prediction.åå·®ç‡.toFixed(2)}</td>
                        <td class="${statusClass}">${statusText}</td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>

                    <div style="margin-top: 20px;">
                        <button class="btn" onclick="alert('å»ºè®®æªæ–½: 1. æ£€æŸ¥å¤©æ°”æ•°æ®å‡†ç¡®æ€§ 2. ä¼˜åŒ–é¢„æµ‹æ¨¡å‹å‚æ•° 3. å¢åŠ å†å²æ•°æ®é‡')">
                            æŸ¥çœ‹ä¼˜åŒ–å»ºè®®
                        </button>
                    </div>
                </div>
            `;

            document.getElementById('pvResult').innerHTML = html;
        }

        // èƒ½è€—åˆ†æ
        async function analyzeEnergy() {
            const plantId = document.getElementById('energyPlant').value;
            const startDate = document.getElementById('energyStartDate').value;
            const endDate = document.getElementById('energyEndDate').value;

            const resultDiv = document.getElementById('energyResult');
            resultDiv.innerHTML = '<div class="loading">æ­£åœ¨åˆ†æèƒ½è€—æ•°æ®...</div>';

            try {
                let url = `/api/analyst/energy-patterns?start_date=${startDate}&end_date=${endDate}`;
                if (plantId) {
                    url += `&plant_id=${plantId}`;
                }

                const response = await fetch(url);
                const data = await response.json();

                if (data.success) {
                    displayEnergyAnalysisResult(data.data);
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">åˆ†æå¤±è´¥: ${error.message}</div>`;
            }
        }

        function displayEnergyAnalysisResult(data) {
            let html = `
                <div class="report-section">
                    <h3>èƒ½è€—åˆ†æç»“æœ (${data.analysis_period.start} è‡³ ${data.analysis_period.end})</h3>

                    <div class="report-item">
                        <p>æ€»èƒ½è€—: ${data.total_analysis.total_energy.toFixed(2)}</p>
                        <p>æ€»æˆæœ¬: ï¿¥${data.total_analysis.total_cost.toFixed(2)}</p>
                        <p>å¹³å‡å³°æ®µå æ¯”: ${data.total_analysis.avg_peak_ratio.toFixed(2)}%</p>
                    </div>

                    <h3 style="margin-top: 20px;">æŒ‰èƒ½æºç±»å‹ç»Ÿè®¡</h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>èƒ½æºç±»å‹</th>
                                <th>æ€»èƒ½è€—</th>
                                <th>æ€»æˆæœ¬ (å…ƒ)</th>
                                <th>å³°æ®µå æ¯” (%)</th>
                                <th>èŠ‚èƒ½æ½œåŠ›</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            Object.entries(data.energy_by_type).forEach(([type, info]) => {
                const savingPotential = data.energy_saving_potential.find(item => item.energy_type === type);
                const potentialText = savingPotential ?
                    `å¯èŠ‚çœçº¦ï¿¥${savingPotential.estimated_saving.toFixed(2)}` : 'è‰¯å¥½';
                const potentialClass = savingPotential ? 'warning' : 'success';

                html += `
                    <tr>
                        <td>${type}</td>
                        <td>${info.total_energy.toFixed(2)}</td>
                        <td>ï¿¥${info.total_cost.toFixed(2)}</td>
                        <td>${info.peak_ratio.toFixed(2)}%</td>
                        <td class="${potentialClass}">${potentialText}</td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>

                    <h3 style="margin-top: 20px;">èŠ‚èƒ½æ½œåŠ›åˆ†æ</h3>
            `;

            if (data.energy_saving_potential.length > 0) {
                data.energy_saving_potential.forEach(item => {
                    html += `
                        <div class="report-item warning">
                            <p><strong>${item.energy_type}:</strong> ${item.suggestion}</p>
                            <p>å½“å‰å³°æ®µå æ¯”: ${item.current_peak_ratio.toFixed(2)}% | é¢„è®¡å¯èŠ‚çœ: ï¿¥${item.estimated_saving.toFixed(2)}</p>
                        </div>
                    `;
                });
            } else {
                html += `
                    <div class="report-item success">
                        <p>å½“å‰èƒ½è€—æ¨¡å¼è‰¯å¥½ï¼Œæ— æ˜æ˜¾èŠ‚èƒ½æ½œåŠ›ã€‚</p>
                    </div>
                `;
            }

            document.getElementById('energyResult').innerHTML = html;
        }

        // ä¿®æ”¹ analyst.html ä¸­çš„ generateReport å‡½æ•°
async function generateReport() {
    const reportType = document.getElementById('reportType').value;
    const year = document.getElementById('reportYear').value;
    const month = document.getElementById('reportMonth').value;

    const resultDiv = document.getElementById('reportResult');
    resultDiv.innerHTML = '<div class="loading">æ­£åœ¨ç”ŸæˆæŠ¥å‘Š...</div>';

    try {
        const response = await fetch('/api/analyst/generate-report', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                report_type: reportType,
                year: parseInt(year),
                month: parseInt(month)
            })
        });

        const data = await response.json();

        if (data.success) {
            // æ˜¾ç¤ºæŠ¥å‘Šå†…å®¹
            resultDiv.innerHTML = `
                <div class="report-section">
                    <div class="report-item success">
                        <h3>æŠ¥å‘Šç”ŸæˆæˆåŠŸï¼</h3>
                        <p><strong>æŠ¥å‘ŠID:</strong> ${data.report_id}</p>
                        <p><strong>å·²ä¿å­˜åˆ°æ•°æ®åº“</strong></p>
                        <p><strong>ç”Ÿæˆæ—¶é—´:</strong> ${new Date().toLocaleString()}</p>
                    </div>

                    <h3>æŠ¥å‘Šå†…å®¹</h3>
                    <div class="report-item" style="background: #f8f9fa; padding: 20px; border-radius: 5px; font-family: monospace; white-space: pre-line; line-height: 1.6;">
                        ${data.report_content}
                    </div>

                    <div style="margin-top: 20px; display: flex; gap: 10px;">
                        <button class="btn" onclick="downloadTextReport('${data.report_id}', \`${data.report_content.replace(/`/g, '\\`')}\`)">
                            ä¸‹è½½æŠ¥å‘Š
                        </button>
                        <button class="btn" onclick="copyToClipboard('${data.report_content.replace(/'/g, "\\'")}')">
                            å¤åˆ¶æŠ¥å‘Š
                        </button>
                    </div>
                </div>
            `;

            // åˆ·æ–°æŠ¥å‘Šåˆ—è¡¨
            loadMyReports();
        } else {
            throw new Error(data.message);
        }
    } catch (error) {
        resultDiv.innerHTML = `<div class="error">ç”ŸæˆæŠ¥å‘Šå¤±è´¥: ${error.message}</div>`;
    }
}

// ä¸‹è½½æŠ¥å‘Šå‡½æ•°
function downloadTextReport(reportId, content) {
    const blob = new Blob([content], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${reportId}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// å¤åˆ¶åˆ°å‰ªè´´æ¿å‡½æ•°
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        alert('æŠ¥å‘Šå†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
    }).catch(err => {
        alert('å¤åˆ¶å¤±è´¥: ' + err);
    });
}
// æ·»åŠ åŠ è½½ç”¨æˆ·æŠ¥å‘Šåˆ—è¡¨çš„å‡½æ•°
async function loadMyReports() {
    try {
        const response = await fetch('/api/analyst/my-simple-reports');
        const data = await response.json();

        if (data.success) {
            displayMyReports(data.data);
        }
    } catch (error) {
        console.error('åŠ è½½æŠ¥å‘Šåˆ—è¡¨å¤±è´¥:', error);
    }
}

// æ˜¾ç¤ºç”¨æˆ·çš„æŠ¥å‘Šåˆ—è¡¨
function displayMyReports(reports) {
    const reportSection = document.getElementById('myReportsSection');
    if (!reportSection) return;

    if (reports.length === 0) {
        reportSection.innerHTML = '<div class="loading">æš‚æ— å†å²æŠ¥å‘Š</div>';
        return;
    }

    let html = `
        <h3>æˆ‘çš„å†å²æŠ¥å‘Š</h3>
        <table class="data-table">
            <thead>
                <tr>
                    <th>æŠ¥å‘Šç±»å‹</th>
                    <th>ç”Ÿæˆæ—¶é—´</th>
                    <th>å†…å®¹é¢„è§ˆ</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
    `;

    reports.forEach(report => {
        html += `
            <tr>
                <td>${report.æŠ¥å‘Šç±»å‹åç§°}</td>
                <td>${report.ç”Ÿæˆæ—¶é—´}</td>
                <td>${report.å†…å®¹é¢„è§ˆ}</td>
                <td>
                    <button class="btn" onclick="viewReportDetail('${report.æŠ¥å‘ŠID}')">æŸ¥çœ‹</button>
                </td>
            </tr>
        `;
    });

    html += `
            </tbody>
        </table>
    `;

    reportSection.innerHTML = html;
}

// æŸ¥çœ‹æŠ¥å‘Šè¯¦æƒ…
// æŸ¥çœ‹æŠ¥å‘Šè¯¦æƒ…
async function viewReportDetail(reportId) {
    try {
        const response = await fetch(`/api/analyst/report/${reportId}`);
        const data = await response.json();

        if (data.success) {
            // ç›´æ¥æ˜¾ç¤ºæŠ¥å‘Šå†…å®¹ï¼Œæ— éœ€æ¨¡æ€æ¡†
            const resultDiv = document.getElementById('reportResult');
            resultDiv.innerHTML = `
                <div class="report-section">
                    <div class="report-item success">
                        <h3>æŠ¥å‘Šè¯¦æƒ…</h3>
                        <p><strong>æŠ¥å‘ŠID:</strong> ${data.data.æŠ¥å‘ŠID}</p>
                        <p><strong>æŠ¥å‘Šç±»å‹:</strong> ${data.data.æŠ¥å‘Šç±»å‹åç§°}</p>
                        <p><strong>ç”Ÿæˆæ—¶é—´:</strong> ${data.data.ç”Ÿæˆæ—¶é—´}</p>
                        <p><strong>ç”Ÿæˆäºº:</strong> ${data.data.ç”Ÿæˆäºº}</p>
                    </div>

                    <h3>æŠ¥å‘Šå†…å®¹</h3>
                    <div class="report-item" style="background: #f8f9fa; padding: 20px; border-radius: 5px; font-family: monospace; white-space: pre-line; line-height: 1.6;">
                        ${data.data.æŠ¥å‘Šå†…å®¹}
                    </div>

                    <div style="margin-top: 20px; display: flex; gap: 10px;">
                        <button class="btn" onclick="downloadTextReport('${data.data.æŠ¥å‘ŠID}', \`${data.data.æŠ¥å‘Šå†…å®¹.replace(/`/g, '\\`')}\`)">
                            ä¸‹è½½æŠ¥å‘Š
                        </button>
                        <button class="btn" onclick="copyToClipboard('${data.data.æŠ¥å‘Šå†…å®¹.replace(/'/g, "\\'")}')">
                            å¤åˆ¶æŠ¥å‘Š
                        </button>
                        <button class="btn" onclick="showSection('report')">
                            è¿”å›
                        </button>
                    </div>
                </div>
            `;
        } else {
            throw new Error(data.message);
        }
    } catch (error) {
        alert(`æŸ¥çœ‹æŠ¥å‘Šå¤±è´¥: ${error.message}`);
    }
}

// æ˜¾ç¤ºæŠ¥å‘Šè¯¦æƒ…æ¨¡æ€æ¡†
function showReportDetailModal(report) {
    let html = `
        <div class="modal-content">
            <div class="modal-header">
                <h3>${report.æŠ¥å‘Šç±»å‹åç§°} - æŠ¥å‘Šè¯¦æƒ…</h3>
                <button class="close-btn" onclick="closeModal()">Ã—</button>
            </div>
            <div class="report-detail">
                <div class="report-info">
                    <p><strong>æŠ¥å‘ŠID:</strong> ${report.æŠ¥å‘ŠID}</p>
                    <p><strong>ç”Ÿæˆæ—¶é—´:</strong> ${report.ç”Ÿæˆæ—¶é—´}</p>
                    <p><strong>ç”Ÿæˆäºº:</strong> ${report.ç”Ÿæˆäºº}</p>
                </div>
                <div class="report-content">
                    <h4>æŠ¥å‘Šå†…å®¹</h4>
                    <pre style="white-space: pre-wrap; max-height: 400px; overflow-y: auto; padding: 15px; background: #f8f9fa; border-radius: 5px;">
${report.æŠ¥å‘Šå†…å®¹}
                    </pre>
                </div>
            </div>
            <div style="margin-top: 20px; text-align: center;">
                <button class="btn" onclick="downloadReport('${report.æŠ¥å‘ŠID}')">ä¸‹è½½æŠ¥å‘Š</button>
                <button class="btn" onclick="closeModal()">å…³é—­</button>
            </div>
        </div>
    `;

    // åˆ›å»ºæ¨¡æ€æ¡†
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.id = 'reportDetailModal';
    modal.innerHTML = html;
    document.body.appendChild(modal);
    modal.style.display = 'block';
}

// å…³é—­æ¨¡æ€æ¡†
function closeModal() {
    const modal = document.getElementById('reportDetailModal');
    if (modal) {
        modal.remove();
    }
}

// åœ¨é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨åˆ›å»ºæŠ¥å‘Šåˆ—è¡¨åŒºåŸŸ
document.addEventListener('DOMContentLoaded', function() {
    // åœ¨æŠ¥å‘Šç”Ÿæˆéƒ¨åˆ†åé¢æ·»åŠ æŠ¥å‘Šåˆ—è¡¨åŒºåŸŸ
    const reportSection = document.getElementById('report');
    const listSection = document.createElement('div');
    listSection.id = 'myReportsSection';
    listSection.innerHTML = '<div class="loading">åŠ è½½æŠ¥å‘Šåˆ—è¡¨...</div>';
    reportSection.appendChild(listSection);

    // åŠ è½½æŠ¥å‘Šåˆ—è¡¨
    loadMyReports();
});

        // åœ¨ analyst.html ä¸­ä¿®æ”¹ displayReportResult å‡½æ•°

function displayReportResult(report) {
    let html = `
        <div class="report-section">
            <div class="report-item success">
                <h3>${report.period}èƒ½æºåˆ†ææŠ¥å‘Š</h3>
                <p><strong>æŠ¥å‘ŠID:</strong> ${report.report_id}</p>
                <p><strong>ç”Ÿæˆæ—¶é—´:</strong> ${report.generation_time}</p>
                <p><strong>æ•°æ®èŒƒå›´:</strong> ${report.data_range?.start || ''} è‡³ ${report.data_range?.end || ''}</p>
            </div>

            <h3>æŠ¥å‘Šæ‘˜è¦</h3>
            <div class="report-item">
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                    <div>
                        <p><strong>æ€»èƒ½è€—:</strong> ${(report.summary?.total_energy_consumption || 0).toFixed(2)}</p>
                        <p><strong>æ€»æˆæœ¬:</strong> ï¿¥${(report.summary?.total_energy_cost || 0).toFixed(2)}</p>
                        <p><strong>å…‰ä¼æ€»å‘ç”µé‡:</strong> ${(report.summary?.total_pv_generation || 0).toFixed(2)} kWh</p>
                    </div>
                    <div>
                        <p><strong>æ€»å‘Šè­¦æ¬¡æ•°:</strong> ${report.summary?.total_alarms || 0}</p>
                        <p><strong>å·²å¤„ç†å‘Šè­¦:</strong> ${report.summary?.resolved_alarms || 0}</p>
                        <p><strong>å‘Šè­¦å¤„ç†ç‡:</strong> ${(report.summary?.resolution_rate || 0).toFixed(1)}%</p>
                    </div>
                </div>
            </div>

            <h3>è¯¦ç»†åˆ†æ</h3>
    `;

    // æŒ‰èƒ½æºç±»å‹åˆ†æ
    if (report.detailed_analysis?.energy_by_type) {
        const energyTypes = report.detailed_analysis.energy_by_type;
        html += `
            <div class="report-item">
                <h4>æŒ‰èƒ½æºç±»å‹ç»Ÿè®¡</h4>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>èƒ½æºç±»å‹</th>
                            <th>èƒ½è€—é‡</th>
                            <th>å æ¯”</th>
                            <th>æˆæœ¬</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        Object.entries(energyTypes).forEach(([type, data]) => {
            html += `
                <tr>
                    <td>${type}</td>
                    <td>${(data.total_energy || 0).toFixed(2)}</td>
                    <td>${(data.percentage || 0).toFixed(1)}%</td>
                    <td>ï¿¥${(data.total_cost || 0).toFixed(2)}</td>
                </tr>
            `;
        });

        html += `
                    </tbody>
                </table>
            </div>
        `;
    }

    // æŒ‰å‚åŒºåˆ†æ
    if (report.detailed_analysis?.energy_by_plant && report.detailed_analysis.energy_by_plant.length > 0) {
        html += `
            <div class="report-item">
                <h4>æŒ‰å‚åŒºç»Ÿè®¡</h4>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>å‚åŒº</th>
                            <th>èƒ½è€—é‡</th>
                            <th>å æ¯”</th>
                            <th>æˆæœ¬</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        report.detailed_analysis.energy_by_plant.forEach(plant => {
            html += `
                <tr>
                    <td>${plant.plant_name || plant.plant_id}</td>
                    <td>${(plant.total_energy || 0).toFixed(2)}</td>
                    <td>${(plant.percentage || 0).toFixed(1)}%</td>
                    <td>ï¿¥${(plant.total_cost || 0).toFixed(2)}</td>
                </tr>
            `;
        });

        html += `
                    </tbody>
                </table>
            </div>
        `;
    }

    // å‘Šè­¦ç»Ÿè®¡
    html += `
        <div class="report-item">
            <h4>å‘Šè­¦ç»Ÿè®¡</h4>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; text-align: center;">
                <div>
                    <p style="color: #e74c3c; font-size: 24px; font-weight: bold;">${report.detailed_analysis?.alarm_statistics?.by_level?.é«˜ || 0}</p>
                    <p>é«˜ç­‰çº§å‘Šè­¦</p>
                </div>
                <div>
                    <p style="color: #f39c12; font-size: 24px; font-weight: bold;">${report.detailed_analysis?.alarm_statistics?.by_level?.ä¸­ || 0}</p>
                    <p>ä¸­ç­‰çº§å‘Šè­¦</p>
                </div>
                <div>
                    <p style="color: #3498db; font-size: 24px; font-weight: bold;">${report.detailed_analysis?.alarm_statistics?.by_level?.ä½ || 0}</p>
                    <p>ä½ç­‰çº§å‘Šè­¦</p>
                </div>
            </div>
            <p style="text-align: center; margin-top: 10px;">
                å‘Šè­¦å¤„ç†ç‡: <strong>${(report.detailed_analysis?.alarm_statistics?.resolution_rate || 0).toFixed(1)}%</strong>
            </p>
        </div>
    `;

    // ä¼˜åŒ–å»ºè®®
    if (report.detailed_analysis?.recommendations && report.detailed_analysis.recommendations.length > 0) {
        html += `
            <div class="report-item">
                <h4>ä¼˜åŒ–å»ºè®®</h4>
                <ul style="list-style-type: disc; padding-left: 20px;">
        `;

        report.detailed_analysis.recommendations.forEach(rec => {
            html += `<li style="margin-bottom: 8px;">${rec}</li>`;
        });

        html += `
                </ul>
            </div>
        `;
    }

    // æ•°æ®è´¨é‡è¯´æ˜
    if (report.raw_data_summary) {
        html += `
            <div class="report-item">
                <h4>æ•°æ®è´¨é‡è¯´æ˜</h4>
                <p>èƒ½è€—è®°å½•æ•°: ${report.raw_data_summary.energy_records || 0}</p>
                <p>å…‰ä¼è®°å½•æ•°: ${report.raw_data_summary.pv_records || 0}</p>
                <p>å‘Šè­¦è®°å½•æ•°: ${report.raw_data_summary.alarm_records || 0}</p>
            </div>
        `;
    }

    html += `
        </div>
    `;

    // æ·»åŠ åˆ°é¡µé¢
    document.getElementById('reportResult').innerHTML += html;
}

        // æ¨¡å‹ä¼˜åŒ–
        async function optimizeModel() {
            const threshold = document.getElementById('deviationThreshold').value;

            if (!threshold || threshold < 0 || threshold > 100) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„åå·®ç‡é˜ˆå€¼ (0-100)');
                return;
            }

            const resultDiv = document.getElementById('optimizationResult');
            resultDiv.innerHTML = '<div class="loading">æ­£åœ¨ä¼˜åŒ–æ¨¡å‹...</div>';

            try {
                const response = await fetch('/api/analyst/optimize-model', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        deviation_threshold: parseFloat(threshold)
                    })
                });

                const data = await response.json();

                if (data.success) {
                    displayOptimizationResult(data.data);
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">ä¼˜åŒ–å¤±è´¥: ${error.message}</div>`;
            }
        }

        function displayOptimizationResult(data) {
            let html = `
                <div class="report-section">
                    <h3>æ¨¡å‹ä¼˜åŒ–ç»“æœ</h3>
                    <div class="report-item success">
                        <p>æ¨¡å‹ä¼˜åŒ–æˆåŠŸå®Œæˆï¼</p>
                        <p>æ–°æ¨¡å‹ç‰ˆæœ¬: <strong>${data.new_model_version}</strong></p>
                        <p>åˆ†æé¢„æµ‹æ•°æ®: ${data.analyzed_predictions} æ¡</p>
                        <p>å—å½±å“è®¾å¤‡: ${data.affected_devices.length} å°</p>
                    </div>

                    <h3 style="margin-top: 20px;">ä¼˜åŒ–å»ºè®®</h3>
                    <div class="report-item">
                        <ul>
            `;

            data.optimization_suggestions.forEach(suggestion => {
                html += `<li>${suggestion}</li>`;
            });

            html += `
                        </ul>
                    </div>

                    <div style="margin-top: 20px;">
                        <button class="btn" onclick="alert('æ¨¡å‹éƒ¨ç½²ä¸­... é¢„è®¡éœ€è¦5åˆ†é’Ÿå®Œæˆéƒ¨ç½²ã€‚')">
                            éƒ¨ç½²æ–°æ¨¡å‹
                        </button>
                    </div>
                </div>
            `;

            document.getElementById('optimizationResult').innerHTML = html;
        }

        // è¾…åŠ©å‡½æ•°
        function downloadReport(reportId) {
            alert(`æ¨¡æ‹Ÿä¸‹è½½æŠ¥å‘Š: ${reportId}.pdf\nåœ¨å®é™…ç³»ç»Ÿä¸­ï¼Œè¿™é‡Œä¼šç”Ÿæˆå¹¶ä¸‹è½½PDFæŠ¥å‘Šã€‚`);
        }

        function logout() {
            fetch('/logout', { method: 'POST' })
                .then(() => {
                    window.location.href = '/';
                })
                .catch(error => {
                    console.error('ç™»å‡ºå¤±è´¥:', error);
                    window.location.href = '/';
                });
        }

        // ç›‘å¬æŠ¥å‘Šç±»å‹å˜åŒ–ï¼Œæ˜¾ç¤º/éšè—æœˆä»½é€‰æ‹©
        document.getElementById('reportType').addEventListener('change', function() {
            const monthGroup = document.getElementById('monthGroup');
            if (this.value === 'monthly') {
                monthGroup.style.display = 'flex';
            } else {
                monthGroup.style.display = 'none';
            }
        });
    </script>
</body>
</html>